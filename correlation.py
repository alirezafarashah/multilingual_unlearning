import numpy as np
from scipy.stats import pearsonr
from skbio.stats.distance import mantel, DistanceMatrix


langs = ["en","fr","ru","ar","ja","fa","hi","ko","iw","id"]

# --- 1) Language distance (10x10) ---
# dist = np.array([
#     [0.0, 46.9, 52.5, 85.5, 87.2, 77.3, 68.9, 89.2, 91.4, 86.7],
#     [46.9, 0.0, 50.5, 78.9, 86.8, 61.1, 54.5, 82.6, 79.8, 79.7],
#     [52.5, 50.5, 0.0, 80.8, 93.3, 63.8, 64.7, 87.0, 82.0, 84.2],
#     [85.5, 78.9, 80.8, 0.0, 80.7, 78.4, 75.2, 78.6, 27.9, 84.8],
#     [87.2, 86.8, 93.3, 80.7, 0.0, 81.3, 78.0, 84.3, 87.9, 74.8],
#     [77.3, 61.1, 63.8, 78.4, 81.3, 0.0, 49.2, 76.9, 74.4, 86.5],
#     [68.9, 54.5, 64.7, 75.2, 78.0, 49.2, 0.0, 78.0, 78.9, 83.5],
#     [89.2, 82.6, 87.0, 78.6, 84.3, 76.9, 78.0, 0.0, 84.2, 91.2],
#     [91.4, 79.8, 82.0, 27.9, 87.9, 74.4, 78.9, 84.2, 0.0, 86.7],
#     [86.7, 79.7, 84.2, 84.8, 74.8, 86.5, 83.5, 91.2, 86.7, 0.0]
# ])


# inventory
dist = np.array([
    [0.000000, 0.475300, 0.559400, 0.598300, 0.547200, 0.598300, 0.468400, 0.486600, 0.554900, 0.454600],
    [0.475300, 0.000000, 0.515200, 0.602500, 0.505200, 0.602500, 0.461800, 0.480400, 0.608200, 0.468800],
    [0.559400, 0.515200, 0.000000, 0.688000, 0.541200, 0.688000, 0.601500, 0.651100, 0.615600, 0.503000],
    [0.598300, 0.602500, 0.688000, 0.000000, 0.659700, 0.000000, 0.536300, 0.673700, 0.702800, 0.669000],
    [0.547200, 0.505200, 0.541200, 0.659700, 0.000000, 0.659700, 0.498000, 0.520400, 0.562000, 0.459900],
    [0.598300, 0.602500, 0.688000, 0.000000, 0.659700, 0.000000, 0.536300, 0.673700, 0.702800, 0.669000],
    [0.468400, 0.461800, 0.601500, 0.536300, 0.498000, 0.536300, 0.000000, 0.558000, 0.562900, 0.481600],
    [0.486600, 0.480400, 0.651100, 0.673700, 0.520400, 0.673700, 0.558000, 0.000000, 0.588600, 0.456900],
    [0.554900, 0.608200, 0.615600, 0.702800, 0.562000, 0.702800, 0.562900, 0.588600, 0.000000, 0.499500],
    [0.454600, 0.468800, 0.503000, 0.669000, 0.459900, 0.669000, 0.481600, 0.456900, 0.499500, 0.000000]
])


# phonological
# dist = np.array([
#     [0.000000, 0.427000, 0.280400, 0.568700, 0.503200, 0.568700, 0.343300, 0.463800, 0.568700, 0.273600],
#     [0.427000, 0.000000, 0.333300, 0.545600, 0.440700, 0.545600, 0.267700, 0.580400, 0.545600, 0.427000],
#     [0.280400, 0.333300, 0.000000, 0.616200, 0.432700, 0.616200, 0.204800, 0.500000, 0.616200, 0.280400],
#     [0.568700, 0.545600, 0.616200, 0.000000, 0.616200, 0.000200, 0.592200, 0.641000, 0.000200, 0.568700],
#     [0.503200, 0.440700, 0.432700, 0.616200, 0.000000, 0.616200, 0.471700, 0.687500, 0.616200, 0.503200],
#     [0.568700, 0.545600, 0.616200, 0.000200, 0.616200, 0.000000, 0.592200, 0.641000, 0.000200, 0.568700],
#     [0.343300, 0.267700, 0.204800, 0.592200, 0.471700, 0.592200, 0.000000, 0.531900, 0.592200, 0.343300],
#     [0.463800, 0.580400, 0.500000, 0.641000, 0.687500, 0.641000, 0.531900, 0.000000, 0.641000, 0.463800],
#     [0.568700, 0.545600, 0.616200, 0.000200, 0.616200, 0.000200, 0.592200, 0.641000, 0.000000, 0.568700],
#     [0.273600, 0.427000, 0.280400, 0.568700, 0.503200, 0.568700, 0.343300, 0.463800, 0.568700, 0.000000],
# ])

# syntactic
# dist = np.array([
#     [0.000000, 0.460000, 0.490000, 0.670000, 0.660000, 0.570000, 0.590000, 0.620000, 0.520000, 0.520000],
#     [0.460000, 0.000000, 0.510000, 0.670000, 0.710000, 0.570000, 0.580000, 0.690000, 0.470000, 0.560000],
#     [0.490000, 0.510000, 0.000000, 0.670000, 0.660000, 0.570000, 0.500000, 0.560000, 0.430000, 0.610000],
#     [0.670000, 0.670000, 0.670000, 0.000000, 0.870000, 0.670000, 0.740000, 0.810000, 0.600000, 0.600000],
#     [0.660000, 0.710000, 0.660000, 0.870000, 0.000000, 0.590000, 0.600000, 0.400000, 0.690000, 0.760000],
#     [0.570000, 0.570000, 0.570000, 0.670000, 0.590000, 0.000000, 0.580000, 0.570000, 0.540000, 0.620000],
#     [0.590000, 0.580000, 0.500000, 0.740000, 0.600000, 0.580000, 0.000000, 0.470000, 0.530000, 0.670000],
#     [0.620000, 0.690000, 0.560000, 0.810000, 0.400000, 0.570000, 0.470000, 0.000000, 0.660000, 0.700000],
#     [0.520000, 0.470000, 0.430000, 0.600000, 0.690000, 0.540000, 0.530000, 0.660000, 0.000000, 0.540000],
#     [0.520000, 0.560000, 0.610000, 0.600000, 0.760000, 0.620000, 0.670000, 0.700000, 0.540000, 0.000000],
# ])


# --- 2) Impact matrix (10x10) ---
impact = np.array([
    [0.00, 0.25, 0.50, 0.69, 0.63, 0.72, 0.88, 0.32, 0.66, 0.30],
    [0.33, 0.03, 0.50, 0.67, 0.72, 0.71, 0.88, 0.44, 0.67, 0.26],
    [0.46, 0.52, 0.01, 0.65, 0.68, 0.66, 0.82, 0.67, 0.66, 0.46],
    [0.69, 0.66, 0.71, 0.01, 0.81, 0.58, 0.90, 0.80, 0.70, 0.66],
    [0.70, 0.71, 0.74, 0.81, 0.00, 0.75, 0.77, 0.31, 0.78, 0.74],
    [0.68, 0.66, 0.57, 0.46, 0.71, 0.00, 0.77, 0.72, 0.63, 0.63],
    [0.80, 0.81, 0.76, 0.79, 0.61, 0.69, 0.05, 0.68, 0.83, 0.87],
    [0.29, 0.44, 0.65, 0.77, 0.38, 0.74, 0.80, 0.00, 0.80, 0.45],
    [0.64, 0.61, 0.61, 0.58, 0.73, 0.65, 0.86, 0.74, 0.01, 0.61],
    [0.34, 0.30, 0.55, 0.64, 0.73, 0.66, 0.84, 0.54, 0.60, 0.00]
])

impact1 = np.array([
    [0.00, 0.14, 0.38, 0.60, 0.55, 0.65, 0.81, 0.24, 0.56, 0.19],
    [0.12, 0.00, 0.36, 0.52, 0.64, 0.57, 0.85, 0.29, 0.54, 0.21],
    [0.20, 0.24, 0.00, 0.50, 0.41, 0.34, 0.49, 0.36, 0.36, 0.19],
    [0.49, 0.50, 0.56, 0.01, 0.68, 0.46, 0.83, 0.66, 0.56, 0.57],
    [0.44, 0.49, 0.47, 0.61, 0.00, 0.51, 0.55, 0.19, 0.57, 0.45],
    [0.57, 0.52, 0.39, 0.31, 0.54, 0.00, 0.64, 0.59, 0.47, 0.52],
    [0.72, 0.77, 0.66, 0.73, 0.51, 0.59, 0.03, 0.54, 0.72, 0.72],
    [0.12, 0.27, 0.49, 0.70, 0.30, 0.63, 0.72, 0.00, 0.68, 0.27],
    [0.27, 0.28, 0.26, 0.50, 0.52, 0.43, 0.66, 0.40, 0.00, 0.27],
    [0.06, 0.07, 0.23, 0.41, 0.47, 0.38, 0.68, 0.22, 0.39, 0.00]
])


impact2 = np.array([
    [0.26, 0.71, 0.84, 0.92, 0.90, 0.95, 0.98, 0.74, 0.88, 0.80],
    [0.72, 0.35, 0.83, 0.90, 0.91, 0.91, 0.98, 0.78, 0.88, 0.77],
    [0.85, 0.88, 0.26, 0.93, 0.95, 0.92, 0.97, 0.93, 0.92, 0.89],
    [0.93, 0.92, 0.95, 0.29, 0.97, 0.90, 0.99, 0.97, 0.93, 0.93],
    [0.95, 0.95, 0.95, 0.97, 0.28, 0.96, 0.96, 0.85, 0.97, 0.96],
    [0.93, 0.91, 0.91, 0.87, 0.95, 0.25, 0.97, 0.96, 0.92, 0.90],
    [0.95, 0.97, 0.94, 0.94, 0.90, 0.92, 0.57, 0.91, 0.97, 0.98],
    [0.85, 0.87, 0.92, 0.97, 0.83, 0.96, 0.97, 0.28, 0.97, 0.89],
    [0.90, 0.89, 0.90, 0.91, 0.97, 0.92, 0.98, 0.95, 0.28, 0.89],
    [0.82, 0.80, 0.90, 0.93, 0.95, 0.94, 0.98, 0.89, 0.92, 0.31]
])


# ### between methods:
# # --- Flatten the matrices ---
# vec = impact.flatten()
# vec1 = impact1.flatten()
# vec2 = impact2.flatten()

# # --- Compute correlations (Pearson) ---
# r01, p01 = pearsonr(vec, vec1)
# r02, p02 = pearsonr(vec, vec2)
# r12, p12 = pearsonr(vec1, vec2)

# print(f"Correlation (impact vs impact1): r={r01:.4f}, p={p01:.4e}")
# print(f"Correlation (impact vs impact2): r={r02:.4f}, p={p02:.4e}")
# print(f"Correlation (impact1 vs impact2): r={r12:.4f}, p={p12:.4e}")



# n = impact.shape[0]
# row_col_corr = []

# for i in range(n):
#     row = np.delete(impact[i, :], i)      # row i without diagonal element
#     col = np.delete(impact[:, i], i)      # column i without diagonal element
#     corr = np.corrcoef(row, col)[0, 1]    # Pearson correlation
#     row_col_corr.append(corr)

# print("Row vs Column correlations (excluding diagonal):")
# for i, c in enumerate(row_col_corr):
#     print(f"Index {i}: correlation = {c:.3f}")



# mask = ~np.eye(n, dtype=bool)

# rows_flat = impact[mask].reshape(n, -1).flatten(order='C')  # row-wise
# cols_flat = impact[mask].reshape(n, -1).flatten(order='F')  # column-wise

# global_corr = np.corrcoef(rows_flat, cols_flat)[0,1]
# print("Global off-diagonal correlation:", global_corr)




# flatten distance matrix (upper triangle, no diagonals)
dist_flat = dist[np.triu_indices_from(dist, k=1)]

# flatten impact matrix (same upper triangle for fair comparison)
impact_sym = (impact + impact.T) / 2  # symmetrize
impact_flat = impact_sym[np.triu_indices_from(impact_sym, k=1)]

corr, pval = pearsonr(dist_flat, impact_flat)
print("Correlation Triu:", corr, "p-value:", pval)

# mask = ~np.eye(len(langs), dtype=bool)
# dist_flat   = dist[mask]
# impact_flat = impact[mask]

# corr, pval = pearsonr(dist_flat, impact_flat)
# print("Pearson correlation:", corr, "p-value:", pval)

for i in range(10):
    corr, _ = pearsonr(dist[i], impact[i])
    print(f"Lang {i}: correlation = {corr:.3f}")





# flatten everything (including diagonal)
dist_flat = dist.ravel()
impact_flat = impact.ravel()
corr, pval = pearsonr(dist_flat, impact_flat)
print("Correlation (full matrix):", corr, "p-value:", pval)



mask = ~np.eye(impact.shape[0], dtype=bool)  # exclude diagonal
dist_flat = dist[mask]
impact_flat = impact[mask]
corr, pval = pearsonr(dist_flat, impact_flat)
print("Correlation:", corr, "p-value:", pval)



#Mantel Test

impact_sym = (impact + impact.T) / 2
# set diagonal to 0
np.fill_diagonal(impact_sym, 0)
# wrap them as DistanceMatrix objects
dist_dm = DistanceMatrix(dist)
impact_dm = DistanceMatrix(impact_sym)
# run Mantel test
corr, pval, n_perm = mantel(dist_dm, impact_dm, method='pearson', permutations=999)
print("Mantel correlation:", corr, "p-value:", pval)